!function(e){"use strict";"undefined"==typeof ffcAudience&&(window.ffcAudience={ajaxUrl:"/wp-admin/admin-ajax.php",restUrl:"/wp-json/ffc/v1/audience/",nonce:""}),ffcAudience.strings||(ffcAudience.strings={}),ffcAudience.locale&&(ffcAudience.locale=ffcAudience.locale.replace("_","-"));var n={months:["January","February","March","April","May","June","July","August","September","October","November","December"],loading:"Loading...",error:"An error occurred. Please try again.",noBookings:"No bookings for this day.",noActiveBookings:"No active bookings for this day.",bookingCreated:"Booking created successfully!",bookingCancelled:"Booking cancelled successfully.",confirmCancel:"Are you sure you want to cancel this booking?",cancelReason:"Please provide a reason for cancellation:",invalidTime:"End time must be after start time.",selectAudience:"Please select at least one audience.",selectUser:"Please select at least one user.",descriptionRequired:"Description is required (15-300 characters).",conflictWarning:"Warning: Conflicts detected with existing bookings.",holiday:"Holiday",closed:"Closed",cancelled:"Cancelled",cancel:"Cancel",available:"Available",booked:"Booked",timeout:"Request timed out. Please try again.",checkConflicts:"Check Conflicts",booking:"booking",bookings:"bookings",createBooking:"Create Booking",newBooking:"New Booking"};for(var t in n)ffcAudience.strings[t]||(ffcAudience.strings[t]=n[t]);var c={currentDate:new Date,selectedSchedule:0,selectedEnvironment:0,config:{},bookings:{},holidays:{},selectedUsers:{}};function o(){var n=e("#ffc-environment-select");n.find("option:not(:first)").remove();var t=c.config.schedules||[],o=[];if(c.selectedSchedule>0){for(var i=0;i<t.length;i++)if(parseInt(t[i].id)===parseInt(c.selectedSchedule)){o=t[i].environments||[];break}}else for(var a=0;a<t.length;a++)for(var s=t[a].environments||[],r=0;r<s.length;r++)o.push(s[r]);o.forEach(function(e){n.append('<option value="'+e.id+'">'+e.name+"</option>")}),c.selectedEnvironment>0&&n.val(c.selectedEnvironment)}function i(){var n=c.currentDate.getFullYear(),t=c.currentDate.getMonth();e(".ffc-current-month").text(ffcAudience.strings.months[t]+" "+n);var o=new Date(n,t,1),i=new Date(n,t+1,0),r=o.getDay(),f=i.getDate(),d=new Date(n,t,0).getDate(),l="",u=1,h=1,p=new Date;p.setHours(0,0,0,0),function(n,t,o){var i=n+"-"+m(t)+"-01",a=new Date(n,t,0).getDate(),s=n+"-"+m(t)+"-"+m(a),r={start_date:i,end_date:s};c.selectedSchedule>0&&(r.schedule_id=c.selectedSchedule);c.selectedEnvironment>0&&(r.environment_id=c.selectedEnvironment);e.ajax({url:ffcAudience.restUrl+"bookings",method:"GET",data:r,beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",ffcAudience.nonce)},success:function(e){c.bookings={},c.holidays={},c.closedWeekdays=[],e.bookings&&e.bookings.forEach(function(e){c.bookings[e.booking_date]||(c.bookings[e.booking_date]=[]),c.bookings[e.booking_date].push(e)}),e.holidays&&e.holidays.forEach(function(e){c.holidays[e.holiday_date]=e.description||!0}),e.closed_weekdays&&(c.closedWeekdays=e.closed_weekdays),o&&o()},error:function(){o&&o()}})}(n,t+1,function(){for(var o=0;o<6;o++)for(var i=0;i<7;i++){var m,v,b,k=["ffc-day"];0===o&&i<r?(v=d-r+i+1,m=new Date(n,t-1,v),k.push("ffc-other-month")):u>f?(v=h++,m=new Date(n,t+1,v),k.push("ffc-other-month")):(v=u++,m=new Date(n,t,v)),b=g(m),m<p&&k.push("ffc-past"),m.getTime()===p.getTime()&&k.push("ffc-today");var y=c.holidays[b];y&&(k.push("ffc-holiday"),k.push("ffc-disabled"));var A=m.getDay(),_=c.closedWeekdays&&-1!==c.closedWeekdays.indexOf(A);_&&!y&&(k.push("ffc-closed"),k.push("ffc-disabled"));var w=-1!==k.indexOf("ffc-other-month"),D=-1!==k.indexOf("ffc-past"),x=s(m);w||D||_||y||!x||k.push("ffc-available");var E=a(b);l+='<div class="'+k.join(" ")+'" data-date="'+b+'">',l+='<span class="ffc-day-number">'+v+"</span>",l+='<div class="ffc-day-content">',y?l+='<span class="ffc-day-badge ffc-badge-holiday">'+("string"==typeof y?y:ffcAudience.strings.holiday)+"</span>":_?l+='<span class="ffc-day-badge ffc-badge-closed">'+ffcAudience.strings.closed+"</span>":E>0&&(l+='<span class="ffc-day-badge ffc-badge-bookings">'+E+" "+(1===E?ffcAudience.strings.booking:ffcAudience.strings.bookings)+"</span>"),l+="</div></div>"}e("#ffc-calendar-days").html(l)})}function a(e){return(c.bookings[e]||[]).filter(function(e){return"active"===e.status}).length}function s(e){var n=c.config.schedules||[],t=null;if(c.selectedSchedule>0){for(var o=0;o<n.length;o++)if(n[o].id===c.selectedSchedule){t=n[o].futureDaysLimit;break}}else for(var i=0;i<n.length;i++){var a=n[i].futureDaysLimit;null!==a&&a>0&&(null===t||a<t)&&(t=a)}if(null===t||t<=0)return!0;var s=new Date;return s.setDate(s.getDate()+t),s.setHours(23,59,59,999),e<=s}function r(n){var t=e("#ffc-day-bookings"),o=c.bookings[n]||[],a=e("#ffc-show-cancelled").is(":checked"),s=o.filter(function(e){return!!a||"active"===e.status});if(0===s.length){var f=ffcAudience.strings.noBookings;return!a&&o.length>0&&(f=ffcAudience.strings.noActiveBookings||"No active bookings for this day."),void t.html('<p class="ffc-no-bookings">'+f+"</p>")}var d="";s.sort(function(e,n){return e.start_time.localeCompare(n.start_time)}),s.forEach(function(e){var n=["ffc-booking-item"];"cancelled"===e.status&&n.push("ffc-booking-cancelled"),d+='<div class="'+n.join(" ")+'">',d+='<div class="ffc-booking-time">'+p(e.start_time)+" - "+p(e.end_time)+"</div>",d+='<div class="ffc-booking-description">'+v(e.description)+"</div>",d+='<div class="ffc-booking-meta">',d+="<span><strong>Environment:</strong> "+v(e.environment_name)+"</span>","cancelled"===e.status&&(d+=' <span class="ffc-status-cancelled">('+(ffcAudience.strings.cancelled||"Cancelled")+")</span>"),d+="</div>",e.audiences&&e.audiences.length>0&&(d+='<div class="ffc-booking-audiences">',e.audiences.forEach(function(e){d+='<span class="ffc-audience-tag" style="background-color: '+e.color+'">'+v(e.name)+"</span>"}),d+="</div>"),"active"===e.status&&c.config.canBook&&(d+='<div class="ffc-booking-actions">',d+='<button type="button" class="ffc-btn ffc-btn-danger ffc-cancel-booking" data-id="'+e.id+'">'+ffcAudience.strings.cancel+"</button>",d+="</div>"),d+="</div>"}),t.html(d),t.find(".ffc-cancel-booking").on("click",function(){!function(n,t){var c=prompt(ffcAudience.strings.cancelReason);if(!c||""===c.trim())return;e.ajax({url:ffcAudience.restUrl+"bookings/"+n,method:"DELETE",contentType:"application/json",data:JSON.stringify({reason:c}),beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",ffcAudience.nonce)},success:function(e){e.success?(alert(ffcAudience.strings.bookingCancelled),i(),r(t)):alert(e.message||ffcAudience.strings.error)},error:function(){alert(ffcAudience.strings.error)}})}(e(this).data("id"),n)})}function f(){var n="",t=[];for(var o in c.selectedUsers)n+='<span class="ffc-selected-user">'+v(c.selectedUsers[o])+'<span class="remove" data-id="'+o+'">&times;</span></span>',t.push(o);e("#booking-selected-users").html(n),e("#booking-user-ids").val(t.join(","))}function d(){var n=e("#booking-start-time").val(),t=e("#booking-end-time").val(),c=e("#booking-description").val().trim(),o=e("#booking-type").val();if(!n||!t)return alert("Please fill in the time fields."),!1;if(n>=t)return alert(ffcAudience.strings.invalidTime),!1;if(c.length<15||c.length>300)return alert(ffcAudience.strings.descriptionRequired),!1;if("audience"===o){var i=e("#booking-audiences").val();if(!i||0===i.length)return alert(ffcAudience.strings.selectAudience),!1}else{var a=e("#booking-user-ids").val();if(!a||""===a.trim())return alert(ffcAudience.strings.selectUser),!1}return!0}function l(){var n=e("#booking-type").val(),t={environment_id:parseInt(e("#booking-environment-id").val()),booking_date:e("#booking-date").val(),start_time:e("#booking-start-time").val(),end_time:e("#booking-end-time").val(),booking_type:n,description:e("#booking-description").val().trim(),audience_ids:[],user_ids:[]};return"audience"===n?t.audience_ids=(e("#booking-audiences").val()||[]).map(function(e){return parseInt(e)}):t.user_ids=(e("#booking-user-ids").val()||"").split(",").filter(function(e){return""!==e.trim()}).map(function(e){return parseInt(e)}),t}function u(){e("#ffc-booking-modal, #ffc-day-modal").hide()}function g(e){return e.getFullYear()+"-"+m(e.getMonth()+1)+"-"+m(e.getDate())}function h(e){var n=e.split("-");return new Date(parseInt(n[0],10),parseInt(n[1],10)-1,parseInt(n[2],10))}function p(e){return e?e.substring(0,5):""}function m(e){return(e<10?"0":"")+e}function v(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):""}e(document).ready(function(){var n,t,a,s=e("#ffc-audience-calendar");s.length&&(c.config=JSON.parse(s.attr("data-config")||"{}"),c.selectedSchedule=c.config.scheduleId||0,c.selectedEnvironment=c.config.environmentId||0,o(),(n=e("#booking-audiences")).empty(),(c.config.audiences||[]).forEach(function(e){n.append('<option value="'+e.id+'">'+e.name+"</option>"),e.children&&e.children.length>0&&e.children.forEach(function(e){n.append('<option value="'+e.id+'">   └ '+e.name+"</option>")})}),i(),e(".ffc-prev-month").on("click",function(){c.currentDate.setMonth(c.currentDate.getMonth()-1),i()}),e(".ffc-next-month").on("click",function(){c.currentDate.setMonth(c.currentDate.getMonth()+1),i()}),e(".ffc-today-btn").on("click",function(){c.currentDate=new Date,i()}),e("#ffc-schedule-select").on("change",function(){c.selectedSchedule=parseInt(e(this).val())||0,o(),i()}),e("#ffc-environment-select").on("change",function(){c.selectedEnvironment=parseInt(e(this).val())||0,i()}),e("#ffc-audience-calendar").on("click",".ffc-day:not(.ffc-past):not(.ffc-disabled):not(.ffc-other-month)",function(){var n=e(this).data("date");n&&function(n){var t=e("#ffc-day-modal"),c=h(n),o=c.toLocaleDateString(ffcAudience.locale,{weekday:"long",year:"numeric",month:"long",day:"numeric"});t.find(".ffc-day-modal-title").text(o),t.data("date",n),t.show(),r(n)}(n)}),e("#ffc-booking-modal .ffc-modal-close, #ffc-booking-modal .ffc-modal-cancel, #ffc-day-modal .ffc-modal-close, #ffc-day-modal .ffc-modal-cancel").on("click",function(){u()}),e("#ffc-booking-modal > .ffc-modal-backdrop, #ffc-day-modal > .ffc-modal-backdrop").on("click",function(){u()}),e("#ffc-show-cancelled").on("change",function(){var n=e("#ffc-day-modal").data("date");n&&r(n)}),e("#booking-type").on("change",function(){"audience"===e(this).val()?(e("#audience-select-group").show(),e("#user-select-group").hide()):(e("#audience-select-group").hide(),e("#user-select-group").show())}),a=[],e("#booking-audiences").on("change",function(){var n=e(this),t=(n.val()||[]).map(function(e){return parseInt(e)}),o=c.config.audiences||[],i=t.slice();o.forEach(function(e){if(e.children&&0!==e.children.length){var n=parseInt(e.id),c=e.children.map(function(e){return parseInt(e.id)}),o=-1!==t.indexOf(n),s=-1!==a.indexOf(n);o&&!s?c.forEach(function(e){-1===i.indexOf(e)&&i.push(e)}):!o&&s&&(i=i.filter(function(e){return-1===c.indexOf(e)}))}}),i.length===t.length&&i.every(function(e){return-1!==t.indexOf(e)})||n.val(i.map(String)),a=(n.val()||[]).map(function(e){return parseInt(e)})}),e("#booking-description").on("input",function(){e("#desc-char-count").text(e(this).val().length)}),e("#booking-user-search").on("input",function(){clearTimeout(t);var n=e(this).val();n.length<2?e("#booking-user-results").removeClass("active").empty():t=setTimeout(function(){!function(n){e.ajax({url:ffcAudience.ajaxUrl,method:"GET",data:{action:"ffc_search_users",query:n,nonce:ffcAudience.nonce},success:function(n){if(n.success&&n.data.length>0){var t="";n.data.forEach(function(e){c.selectedUsers[e.id]||(t+='<div class="ffc-user-result" data-id="'+e.id+'" data-name="'+v(e.name)+'">'+v(e.name)+" ("+v(e.email)+")</div>")}),e("#booking-user-results").html(t).addClass("active")}else e("#booking-user-results").removeClass("active").empty()}})}(n)},300)}),e(document).on("click","#booking-user-results .ffc-user-result",function(){var n=e(this).data("id"),t=e(this).data("name");c.selectedUsers[n]=t,f(),e("#booking-user-results").removeClass("active").empty(),e("#booking-user-search").val("")}),e(document).on("click","#booking-selected-users .remove",function(){var n=e(this).data("id");delete c.selectedUsers[n],f()}),e("#ffc-check-conflicts-btn").on("click",function(){!function(){if(d()){var n=l(),t=e("#ffc-check-conflicts-btn"),c=t.text();t.prop("disabled",!0).text(ffcAudience.strings.loading),e.ajax({url:ffcAudience.restUrl+"conflicts",method:"POST",contentType:"application/json",timeout:3e4,data:JSON.stringify({environment_id:n.environment_id,booking_date:n.booking_date,start_time:n.start_time,end_time:n.end_time,audience_ids:n.audience_ids,user_ids:n.user_ids}),beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",ffcAudience.nonce)},success:function(n){try{if(n.success){var c=n.conflicts||{},o="environment"===c.type||"audience_same_day"===c.type;if(e("#ffc-conflict-warning").hide(),e("#ffc-conflict-error").hide(),e("#ffc-conflict-acknowledge").prop("checked",!1),o){var i="";if("environment"===c.type)i="<p><strong>"+(ffcAudience.strings.hardConflict||"This time slot is already booked for this environment.")+"</strong></p><p>"+c.bookings.map(function(e){return e.start_time+"–"+e.end_time}).join(", ")+"</p>";else if("audience_same_day"===c.type){var a={};c.audience_same_day.forEach(function(e){a[e.audience_name]||(a[e.audience_name]=[]),a[e.audience_name].push(e.start_time+"–"+e.end_time)});var s=[];for(var r in a)s.push("<strong>"+r+"</strong>: "+a[r].join(", "));i="<p><strong>"+(ffcAudience.strings.audienceSameDayHard||"This audience group already has a booking on this day.")+"</strong></p><p>"+s.join("<br>")+"</p>"}e("#ffc-conflict-error-details").html(i),e("#ffc-conflict-error").show(),t.hide(),e("#ffc-create-booking-btn").hide()}else{var f=[];if(c.bookings&&c.bookings.length>0&&"user"===c.type){var d=c.affected_users?c.affected_users.length:0;f.push(d+" "+(ffcAudience.strings.membersOverlapping||"member(s) have overlapping bookings."))}t.hide(),f.length>0?(e("#ffc-conflict-details").html(f.join("<br><br>")),e("#ffc-conflict-warning").show(),e("#ffc-create-booking-btn").show().prop("disabled",!0)):e("#ffc-create-booking-btn").show().prop("disabled",!1)}}else alert(n.message||ffcAudience.strings.error)}catch(e){console.error("Error processing conflict response:",e),alert(ffcAudience.strings.error)}},error:function(e,n,t){console.error("Conflict check error:",n,t,e.responseText);var c=ffcAudience.strings.error;e.responseJSON&&e.responseJSON.message?c=e.responseJSON.message:"timeout"===n&&(c=ffcAudience.strings.timeout),alert(c)},complete:function(){t.prop("disabled",!1).text(c)}})}}()}),e("#ffc-create-booking-btn").on("click",function(){!function(){if(d()){var n=l();e("#ffc-create-booking-btn").prop("disabled",!0).text(ffcAudience.strings.loading),e.ajax({url:ffcAudience.restUrl+"bookings",method:"POST",contentType:"application/json",data:JSON.stringify(n),beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",ffcAudience.nonce)},success:function(n){n.success?(alert(ffcAudience.strings.bookingCreated),u(),i()):(e("#ffc-create-booking-btn").prop("disabled",!1).text(ffcAudience.strings.createBooking),alert(n.message||ffcAudience.strings.error))},error:function(){e("#ffc-create-booking-btn").prop("disabled",!1).text(ffcAudience.strings.createBooking),alert(ffcAudience.strings.error)}})}}()}),e("#ffc-conflict-acknowledge").on("change",function(){e("#ffc-create-booking-btn").prop("disabled",!e(this).is(":checked"))}),e("#ffc-new-booking-btn").on("click",function(){var n=e("#ffc-day-modal").data("date");u(),function(n,t){var o=e("#ffc-booking-modal"),i=h(n),a=i.toLocaleDateString(ffcAudience.locale,{weekday:"long",year:"numeric",month:"long",day:"numeric"});e("#ffc-booking-form")[0].reset(),c.selectedUsers={},f(),e("#ffc-conflict-warning").hide(),e("#ffc-conflict-error").hide(),e("#ffc-conflict-acknowledge").prop("checked",!1),e("#ffc-check-conflicts-btn").show(),e("#ffc-create-booking-btn").hide().prop("disabled",!1),e("#desc-char-count").text("0"),e("#booking-date").val(n),e(".ffc-booking-date-display").text(a);var s=e("#booking-environment-id");s.empty();for(var r=c.config.schedules||[],d=[],l=0;l<r.length;l++)for(var u=r[l].environments||[],g=0;g<u.length;g++)d.push({id:u[g].id,name:u[g].name,scheduleName:r[l].name});if(d.length>1){var p=r.length>1;d.forEach(function(e){var n=p?e.scheduleName+" - "+e.name:e.name;s.append('<option value="'+e.id+'">'+n+"</option>")})}else 1===d.length&&s.append('<option value="'+d[0].id+'">'+d[0].name+"</option>");var m=t||c.selectedEnvironment||"";s.val(m),e("#booking-type").val("audience").trigger("change"),o.show()}(n)}),e("#ffc-booking-modal .ffc-modal-content, #ffc-day-modal .ffc-modal-content").on("click",function(e){e.stopPropagation()}))})}(jQuery);