!function(e){"use strict";var t=window.ffcReregistration&&window.ffcReregistration.strings||{};function r(r){var a=r.closest(".ffc-rereg-field"),i=a.find(".ffc-field-error"),n=e.trim(r.val()),s="";if(r.prop("required")&&!n&&(s=t.required||"This field is required."),!s&&n){var f=a.data("format");if("cpf"===f)(function(e){if(11!==(e=e.replace(/\D/g,"")).length)return!1;if(/^(\d)\1{10}$/.test(e))return!1;for(var t=9;t<11;t++){for(var r=0,a=0;a<t;a++)r+=parseInt(e.charAt(a),10)*(t+1-a);if(r=10*r%11%10,parseInt(e.charAt(t),10)!==r)return!1}return!0})(n)||(s=t.invalidCpf||"Invalid CPF.");else if("email"===f)/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)||(s=t.invalidEmail||"Invalid email.");else if("phone"===f)/^\(?\d{2}\)?\s?\d{4,5}-?\d{4}$/.test(n.replace(/\s+/g,""))||(s=t.invalidPhone||"Invalid phone number.");else if("custom_regex"===f){var o=a.data("regex");if(o)try{new RegExp(o).test(n)||(s=a.data("regex-msg")||t.invalidFormat||"Invalid format.")}catch(e){}}}return a.toggleClass("has-error",!!s),i.text(s),!s}function a(t){var r={};return t.find('[name^="standard_fields["]').each(function(){var t=this.name.match(/\[(\w+)\]/)[1];r[t]=e(this).val()}),r}function i(t){var r={};return t.find('[name^="custom_fields["]').each(function(){var t=this.name.match(/\[(field_\d+)\]/)[1];"checkbox"===this.type?r[t]=this.checked?"1":"":r[t]=e(this).val()}),r}e(function(){e(document).on("click",".ffc-rereg-open-form",function(){var n,s,f=e(this).data("reregistration-id");n=f,(s=e("#ffc-rereg-form-panel")).html('<div class="ffc-loading">'+(t.loading||"Loading form...")+"</div>").show(),e("html, body").animate({scrollTop:s.offset().top-40},300),e.post(ffcReregistration.ajaxUrl,{action:"ffc_get_reregistration_form",nonce:ffcReregistration.nonce,reregistration_id:n},function(n){var f;n.success?(s.html(n.data.html),function(e){e.find('[data-mask="cpf"]').on("input",function(){var e=this.value.replace(/\D/g,"").substring(0,11);e.length>9?e=e.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/,"$1.$2.$3-$4"):e.length>6?e=e.replace(/(\d{3})(\d{3})(\d{1,3})/,"$1.$2.$3"):e.length>3&&(e=e.replace(/(\d{3})(\d{1,3})/,"$1.$2")),this.value=e}),e.find('[data-mask="phone"]').on("input",function(){var e=this.value.replace(/\D/g,"").substring(0,11);e.length>6?e=e.replace(/(\d{2})(\d{4,5})(\d{4})/,"($1) $2-$3"):e.length>2&&(e=e.replace(/(\d{2})(\d{1,5})/,"($1) $2")),this.value=e})}(f=s),function(t){t.on("blur","input, textarea, select",function(){r(e(this))})}(f),function(r){r.on("click",".ffc-rereg-draft-btn",function(){var n=e(this),s=r.find(".ffc-rereg-status"),f=r.find('[name="reregistration_id"]').val();n.prop("disabled",!0).text(t.saving||"Saving..."),s.text(""),e.post(ffcReregistration.ajaxUrl,{action:"ffc_save_reregistration_draft",nonce:ffcReregistration.nonce,reregistration_id:f,standard_fields:a(r),custom_fields:i(r)},function(e){n.prop("disabled",!1).text(t.saveDraft||"Save Draft"),e.success?(s.text(t.draftSaved||"Draft saved.").addClass("ffc-status-ok"),setTimeout(function(){s.text("").removeClass("ffc-status-ok")},3e3)):s.text(e.data&&e.data.message?e.data.message:t.errorSaving||"Error saving draft.").addClass("ffc-status-err")}).fail(function(){n.prop("disabled",!1).text(t.saveDraft||"Save Draft"),s.text(t.errorSaving||"Error saving draft.").addClass("ffc-status-err")})})}(f),function(n){n.on("submit","#ffc-rereg-form",function(s){s.preventDefault();var f=!0;if(n.find("input[required], textarea[required], select[required]").each(function(){r(e(this))||(f=!1)}),n.find("[data-format]").each(function(){var t=e(this).find("input, textarea, select");t.val()&&(r(t)||(f=!1))}),f){var o=n.find(".ffc-rereg-submit-btn"),d=n.find(".ffc-rereg-status"),c=n.find('[name="reregistration_id"]').val();o.prop("disabled",!0).text(t.submitting||"Submitting..."),d.text("").removeClass("ffc-status-err ffc-status-ok"),e.post(ffcReregistration.ajaxUrl,{action:"ffc_submit_reregistration",nonce:ffcReregistration.nonce,reregistration_id:c,standard_fields:a(n),custom_fields:i(n)},function(r){r.success?(n.find("#ffc-rereg-form").replaceWith('<div class="ffc-dashboard-notice ffc-notice-info"><p>'+(r.data.message||t.submitted||"Reregistration submitted successfully!")+"</p></div>"),e('.ffc-rereg-banner[data-reregistration-id="'+c+'"]').slideUp()):(o.prop("disabled",!1).text(t.submit||"Submit"),r.data&&r.data.errors&&function(t,r){t.find(".has-error").removeClass("has-error"),t.find(".ffc-field-error").text(""),e.each(r,function(e,r){var a=t.find('[name="'+e+'"]').closest(".ffc-rereg-field");a.addClass("has-error"),a.find(".ffc-field-error").text(r)});var a=t.find(".has-error:first");a.length&&e("html, body").animate({scrollTop:a.offset().top-60},300)}(n,r.data.errors),d.text(r.data&&r.data.message?r.data.message:t.errorSubmitting||"Error submitting.").addClass("ffc-status-err"))}).fail(function(){o.prop("disabled",!1).text(t.submit||"Submit"),d.text(t.errorSubmitting||"Error submitting.").addClass("ffc-status-err")})}else{n.find(".ffc-rereg-status").text(t.fixErrors||"Please fix the errors below.").addClass("ffc-status-err");var l=n.find(".has-error:first");l.length&&e("html, body").animate({scrollTop:l.offset().top-60},300)}})}(f),function(t){t.on("click",".ffc-rereg-cancel-btn",function(){e("#ffc-rereg-form-panel").slideUp(200,function(){e(this).empty()})})}(f)):s.html('<div class="ffc-error">'+(n.data&&n.data.message?n.data.message:t.errorLoading||"Error loading form.")+"</div>")}).fail(function(){s.html('<div class="ffc-error">'+(t.errorLoading||"Error loading form.")+"</div>")})}),e(document).on("click",".ffc-rereg-ficha-btn",function(){var r=e(this),a=r.data("submission-id"),i=r.text();a&&(r.prop("disabled",!0).text(t.generatingPdf||"Generating PDF..."),e.post(ffcReregistration.ajaxUrl,{action:"ffc_download_ficha",nonce:ffcReregistration.nonce,submission_id:a},function(e){r.prop("disabled",!1).text(t.downloadFicha||i),e.success&&e.data.pdf_data?"function"==typeof window.ffcGeneratePDF?window.ffcGeneratePDF(e.data.pdf_data,e.data.pdf_data.filename||"ficha.pdf"):alert(t.errorFicha||"PDF generator not available."):alert(e.data&&e.data.message?e.data.message:t.errorFicha||"Error generating ficha.")}).fail(function(){r.prop("disabled",!1).text(t.downloadFicha||i),alert(t.errorFicha||"Error generating ficha.")}))})})}(jQuery);