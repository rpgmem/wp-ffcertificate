!function(e){"use strict";window.ffcCalendarFrontend={selectedDate:null,selectedTime:null,calendarId:null,init:function(){this.bindEvents()},bindEvents:function(){var t=this;window.FFC&&window.FFC.Frontend&&window.FFC.Frontend.Masks&&"function"==typeof window.FFC.Frontend.Masks.applyCpfRf&&(window.FFC.Frontend.Masks.applyCpfRf(e("#ffc-booking-cpf-rf")),e(document).on("focus","#ffc-booking-cpf-rf",function(){window.FFC.Frontend.Masks.applyCpfRf(e(this))})),e(document).on("click",".ffc-timeslot:not(.ffc-timeslot-full)",function(){t.selectTimeSlot(e(this))}),e(document).on("keydown",".ffc-timeslot:not(.ffc-timeslot-full)",function(a){"Enter"!==a.key&&" "!==a.key||(a.preventDefault(),t.selectTimeSlot(e(this)))}),e(document).on("submit","#ffc-self-scheduling-form",function(a){a.preventDefault(),t.submitBooking(e(this))}),e(document).on("click",".ffc-btn-back",function(e){e.preventDefault(),t.backToTimeSlots()}),e(document).on("click",".ffc-btn-new-booking",function(e){e.preventDefault(),t.resetCalendar()}),e(document).on("click","#ffc-self-scheduling-modal .ffc-modal-close, #ffc-self-scheduling-modal .ffc-modal-backdrop",function(){t.closeModal()}),e(document).on("click","#ffc-self-scheduling-modal .ffc-modal-content",function(e){e.stopPropagation()}),e(document).on("keydown",function(a){"Escape"===a.key&&e("#ffc-self-scheduling-modal").is(":visible")&&t.closeModal()}),e(document).on("click",".ffc-download-receipt-btn",function(t){t.preventDefault();var a=e(this).data("pdfData");if(a&&"function"==typeof window.ffcGeneratePDF){var n=a.filename||"appointment_receipt.pdf";window.ffcGeneratePDF(a,n)}})},selectTimeSlot:function(t){var a=t.data("time");e(".ffc-timeslot").removeClass("selected").attr("aria-selected","false"),t.addClass("selected").attr("aria-selected","true"),this.selectedTime=a,this.showBookingForm()},openModal:function(){var t=e("#ffc-self-scheduling-modal");this._triggerElement=document.activeElement,t.show(),e("body").css("overflow","hidden"),t.find(".ffc-modal-close").focus(),this._trapFocus(t)},closeModal:function(){e("#ffc-self-scheduling-modal").hide(),e("body").css("overflow",""),e(".ffc-booking-form-wrapper").hide(),e(".ffc-timeslots-wrapper").show(),e(".ffc-timeslot").removeClass("selected").attr("aria-selected","false"),this.selectedTime=null,this._triggerElement&&(this._triggerElement.focus(),this._triggerElement=null)},_trapFocus:function(e){e.off("keydown.focustrap").on("keydown.focustrap",function(t){if("Tab"===t.key){var a=e.find('a[href], button:not([disabled]), input:not([disabled]):not([type="hidden"]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])').filter(":visible"),n=a.first()[0],o=a.last()[0];t.shiftKey&&document.activeElement===n?(t.preventDefault(),o.focus()):t.shiftKey||document.activeElement!==o||(t.preventDefault(),n.focus())}})},loadTimeSlots:function(t,a){var n=this;this.calendarId=t,this.selectedDate=a;var o=e("#ffc-timeslots-container"),f=e(".ffc-timeslots-loading");e("#ffc-self-scheduling-modal").find(".ffc-modal-title").text((ffcCalendar.strings.availableTimes||"Available Times")+" — "+n.formatDate(a)),e(".ffc-timeslots-wrapper").show(),e(".ffc-booking-form-wrapper").hide(),f.show(),o.html(""),n.openModal(),e.ajax({url:ffcCalendar.ajaxurl,type:"POST",data:{action:"ffc_get_available_slots",nonce:ffcCalendar.nonce,calendar_id:t,date:a},success:function(e){f.hide(),e.success&&e.data.slots?n.renderTimeSlots(e.data.slots):o.html('<p class="ffc-no-slots">'+ffcCalendar.strings.noSlots+"</p>")},error:function(){f.hide(),o.html('<p class="ffc-message ffc-message-error">'+ffcCalendar.strings.error+"</p>")}})},formatDate:function(e){var t=e.split("-");if(3!==t.length)return e;var a=parseInt(t[0],10),n=parseInt(t[1],10)-1;return parseInt(t[2],10)+" "+((ffcCalendar.strings.months||[])[n]||t[1])+" "+a},renderTimeSlots:function(t){var a=e("#ffc-timeslots-container"),n="";0!==t.length?(e.each(t,function(e,t){var a=t.available+" / "+t.total,o=0===t.available;n+='<div class="ffc-timeslot'+(o?" ffc-timeslot-full":"")+'" role="option" aria-selected="false"'+(o?"":' tabindex="0"')+(o?' aria-disabled="true"':"")+' data-time="'+t.time+'">',n+='<span class="ffc-timeslot-time">'+t.display+"</span>",n+='<span class="ffc-timeslot-available">'+a+"</span>",n+="</div>"}),a.html(n)):a.html('<p class="ffc-no-slots">'+ffcCalendar.strings.noSlots+"</p>")},showBookingForm:function(){e("#ffc-form-date").val(this.selectedDate),e("#ffc-form-time").val(this.selectedTime),e(".ffc-timeslots-wrapper").hide(),e(".ffc-booking-form-wrapper").show(),e("#ffc-self-scheduling-modal .ffc-modal-title").text(ffcCalendar.strings.yourInformation||"Your Information"),window.FFC&&window.FFC.Frontend&&window.FFC.Frontend.Masks&&"function"==typeof window.FFC.Frontend.Masks.applyCpfRf&&window.FFC.Frontend.Masks.applyCpfRf(e("#ffc-booking-cpf-rf")),e("#ffc-self-scheduling-modal .ffc-modal-content").scrollTop(0);var t=e('#ffc-self-scheduling-form input:not([type="hidden"]):not([readonly]):visible').first();t.length&&t.focus()},submitBooking:function(t){var a=this,n=e(".ffc-form-messages"),o=t.find('button[type="submit"]');if(!o.data("submitting")&&(n.html(""),this.validateForm(t))){o.data("submitting",!0),o.prop("disabled",!0).text(ffcCalendar.strings.loading);var f=t.serialize();e.ajax({url:ffcCalendar.ajaxurl,type:"POST",data:f,timeout:3e4,success:function(e){o.data("submitting",!1),e.success?a.showConfirmation(e.data):(e.data&&e.data.refresh_captcha&&a.refreshCaptcha(e.data.new_label,e.data.new_hash),a.showError(e.data.message||ffcCalendar.strings.error),o.prop("disabled",!1).text(ffcCalendar.strings.submit||"Book Appointment"))},error:function(e,t){o.data("submitting",!1);var n=ffcCalendar.strings.error;"timeout"===t?n=ffcCalendar.strings.timeout||"Connection timeout. Please try again.":0===e.status&&(n=ffcCalendar.strings.networkError||"Network error. Please check your connection and try again."),a.showError(n),o.prop("disabled",!1).text(ffcCalendar.strings.submit||"Book Appointment")}})}},validateForm:function(t){var a=!0;return t.find("[required]").each(function(){e(this).val()&&""!==e(this).val().trim()||(a=!1)}),e("#ffc-booking-consent").is(":checked")?!!a||(this.showError(ffcCalendar.strings.fillRequired),!1):(this.showError(ffcCalendar.strings.consentRequired),!1)},showError:function(t){e(".ffc-form-messages").html('<div class="ffc-message ffc-message-error">'+t+"</div>");var a=e("#ffc-self-scheduling-modal .ffc-modal-content");a.scrollTop(a[0].scrollHeight)},showConfirmation:function(t){var a=this;e("#ffc-self-scheduling-modal").hide(),e("body").css("overflow","");var n='<div class="ffc-appointment-info">';n+="<p><strong>"+ffcCalendar.strings.date+":</strong> "+a.formatDate(a.selectedDate)+"</p>",n+="<p><strong>"+ffcCalendar.strings.time+":</strong> "+(a.selectedTime||"")+"</p>",n+="<p><strong>"+ffcCalendar.strings.name+":</strong> "+e("#ffc-booking-name").val()+"</p>",n+="<p><strong>"+ffcCalendar.strings.email+":</strong> "+e("#ffc-booking-email").val()+"</p>",t.requires_approval?n+="<p><strong>"+ffcCalendar.strings.status+":</strong> "+ffcCalendar.strings.pendingApproval+"</p>":n+="<p><strong>"+ffcCalendar.strings.status+":</strong> "+ffcCalendar.strings.confirmed+"</p>",n+="</div>",t.validation_code&&(n+='<div class="ffc-confirmation-code">',n+="<p><strong>"+(ffcCalendar.strings.validationCode||"Validation Code")+":</strong></p>",n+='<p class="ffc-code-value">'+t.validation_code+"</p>",n+='<p class="ffc-code-help">'+ffcCalendar.strings.confirmationCodeHelp+"</p>",n+="</div>"),n+='<div class="ffc-receipt-actions">',t.pdf_data&&(n+='<button type="button" class="ffc-btn ffc-btn-primary ffc-download-receipt-btn">',n+=ffcCalendar.strings.downloadReceipt,n+="</button>"),t.receipt_url&&(n+=' <a href="'+t.receipt_url+'" class="ffc-btn ffc-btn-secondary" target="_blank">',n+=ffcCalendar.strings.downloadReceipt,n+="</a>"),n+="</div>",e(".ffc-appointment-details").html(n),t.pdf_data&&e(".ffc-download-receipt-btn").data("pdfData",t.pdf_data),e(".ffc-calendar-container").hide(),e(".ffc-confirmation-wrapper").show(),e("html, body").animate({scrollTop:e(".ffc-confirmation-wrapper").offset().top-100},500,function(){e(".ffc-confirmation-success h3").attr("tabindex","-1").focus()}),t.pdf_data&&"function"==typeof window.ffcGeneratePDF&&setTimeout(function(){var e=t.pdf_data.filename||"appointment_receipt.pdf";window.ffcGeneratePDF(t.pdf_data,e)},500)},refreshCaptcha:function(t,a){t&&a&&(e(".ffc-captcha-row label").html(t),e("#ffc_captcha_hash").val(a),e("#ffc_captcha_ans").val("").focus())},backToTimeSlots:function(){e(".ffc-booking-form-wrapper").hide(),e(".ffc-timeslots-wrapper").show(),e(".ffc-timeslot").removeClass("selected"),this.selectedTime=null,e("#ffc-self-scheduling-modal .ffc-modal-title").text((ffcCalendar.strings.availableTimes||"Available Times")+" — "+this.formatDate(this.selectedDate)),e("#ffc-self-scheduling-modal .ffc-modal-content").scrollTop(0);var t=e(".ffc-timeslot:not(.ffc-timeslot-full)").first();t.length&&t.focus()},resetCalendar:function(){e(".ffc-confirmation-wrapper").hide(),e(".ffc-calendar-container").show(),e("#ffc-self-scheduling-form")[0].reset(),e(".ffc-form-messages").html(""),e(".ffc-timeslot").removeClass("selected"),e(".ffc-booking-form-wrapper").hide(),e(".ffc-timeslots-wrapper").show();var t=e('#ffc-self-scheduling-form button[type="submit"]');t.data("submitting",!1),t.prop("disabled",!1).text(ffcCalendar.strings.submit||"Book Appointment"),this.selectedDate=null,this.selectedTime=null,e("html, body").animate({scrollTop:e(".ffc-audience-calendar").offset().top-50},300)},initCalendarCore:function(){if("undefined"!=typeof ffcCalendar&&"undefined"!=typeof FFCCalendarCore){var t=this,a=e('script[id^="ffc-calendar-config-"]').first();if(a.length){var n;try{n=JSON.parse(a.text())}catch(e){return}for(var o=n.calendarId,f=n.workingDays||[],s=n.minDateHours||0,i=n.maxDateDays||30,c=[],r=0;r<7;r++)-1===f.indexOf(r)&&c.push(r);var l=new Date;s>0&&l.setHours(l.getHours()+s),l.setHours(0,0,0,0);var d=new Date;d.setDate(d.getDate()+i),d.setHours(23,59,59,999);var u={},m={},p=null,g=!1,h=e("#ffc-calendar-container-"+o),b=new FFCCalendarCore(h,{showLegend:!0,showTodayButton:!0,minDate:l,maxDate:d,disabledDays:c,strings:ffcCalendar.strings,legendItems:[{class:"ffc-available",label:ffcCalendar.strings.available||"Available"},{class:"ffc-booked",label:ffcCalendar.strings.booked||"Booked"},{class:"ffc-holiday",label:ffcCalendar.strings.holiday||"Holiday"},{class:"ffc-closed",label:ffcCalendar.strings.closed||"Closed"}],getDayClasses:function(e,t){var a=[],n=t.getDay();if(m[e])return a;var o=t>=l,s=t<=d;return-1!==f.indexOf(n)&&o&&s&&a.push("ffc-available"),a},getDayContent:function(e,t,a){if(a)return'<span class="ffc-day-badge ffc-badge-holiday">'+("string"==typeof a?a:ffcCalendar.strings.holiday||"Holiday")+"</span>";var n=u[e]?u[e]:0;if(n>0){var o=ffcCalendar.strings.booking||"booking",f=ffcCalendar.strings.bookings||"bookings";return'<span class="ffc-day-badge ffc-badge-bookings">'+n+" "+(1===n?o:f)+"</span>"}return""},onMonthChange:function(t,a){!function(t,a,n){var f=t+"-"+a;g||p!==f&&(g=!0,e.ajax({url:ffcCalendar.ajaxurl,type:"POST",data:{action:"ffc_get_month_bookings",nonce:ffcCalendar.nonce,calendar_id:o,year:t,month:a},success:function(e){e.success&&(e.data.counts&&(u=e.data.counts),e.data.holidays&&(m=e.data.holidays,b&&(b.options.holidays=m))),p=f,g=!1,n&&n()},error:function(){g=!1,n&&n()}}))}(t,a,function(){b.refresh()})},onDayClick:function(a,n){e("#ffc-selected-date").val(a),t.loadTimeSlots(o,a)}});h.data("calendar",b)}}}},e(document).ready(function(){ffcCalendarFrontend.init(),ffcCalendarFrontend.initCalendarCore()})}(jQuery);