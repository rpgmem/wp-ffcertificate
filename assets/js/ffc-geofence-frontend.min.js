!function(e){"use strict";const t={init:function(){void 0!==window.ffcGeofenceConfig&&(this.debug("FFC Geofence initialized",window.ffcGeofenceConfig),Object.keys(window.ffcGeofenceConfig).forEach(e=>{isNaN(e)||e.startsWith("_")||this.processForm(e,window.ffcGeofenceConfig[e])}))},processForm:function(t,i){const o=e("#ffc-form-"+t);if(0!==o.length){if(this.debug("Processing form",{formId:t,adminBypass:i.adminBypass||!1,datetimeEnabled:!!i.datetime&&i.datetime.enabled,geoEnabled:!!i.geo&&i.geo.enabled,config:i}),!0===i.adminBypass&&i.bypassInfo&&(this.showAdminBypassMessages(o,i.bypassInfo),this.debug("Admin bypass active for some restrictions")),i.datetime&&i.datetime.enabled){const e=this.validateDateTime(i.datetime);if(!e.valid)return void this.handleBlocked(o,i.datetime.hideMode,e.message,i.datetime.message)}i.geo&&i.geo.enabled?i.geo.gpsEnabled?this.validateGeolocation(o,i.geo):i.geo.ipEnabled?(this.showForm(o),this.debug("IP-only validation (backend), showing form")):(this.showForm(o),this.debug("No GPS/IP method enabled, showing form")):(this.showForm(o),this.debug("No geolocation validation, showing form"))}else this.debug("Form wrapper not found for ID: "+t)},getString:function(e,t){return window.ffcGeofenceConfig&&window.ffcGeofenceConfig._global&&window.ffcGeofenceConfig._global.strings&&window.ffcGeofenceConfig._global.strings[e]||t},validateDateTime:function(e){const t=new Date,i=this.formatDate(t),o=this.formatTime(t),a=e.timeMode||"daily";this.debug("DateTime validation",{currentDate:i,currentTime:o,dateStart:e.dateStart,dateEnd:e.dateEnd,timeStart:e.timeStart,timeEnd:e.timeEnd,timeMode:a});const n=e.timeStart&&e.timeEnd,s=e.dateStart&&e.dateEnd,r=s&&e.dateStart!==e.dateEnd;if("span"===a&&s&&n&&r){const i=new Date(e.dateStart+" "+e.timeStart),o=new Date(e.dateEnd+" "+e.timeEnd);return t<i?{valid:!1,message:e.message||this.getString("formNotYetAvailable","This form is not yet available.")}:t>o?{valid:!1,message:e.message||this.getString("formNoLongerAvailable","This form is no longer available.")}:{valid:!0,message:""}}if(e.dateStart&&i<e.dateStart)return{valid:!1,message:e.message||this.getString("formNotYetAvailable","This form is not yet available.")};if(e.dateEnd&&i>e.dateEnd)return{valid:!1,message:e.message||this.getString("formNoLongerAvailable","This form is no longer available.")};if(n){const t=e.timeStart||"00:00",i=e.timeEnd||"23:59";if(o<t||o>i)return{valid:!1,message:e.message||this.getString("formOnlyDuringHours","This form is only available during specific hours.")}}return{valid:!0,message:""}},isSafari:function(){var e=navigator.userAgent;return/^((?!chrome|android).)*safari/i.test(e)||/iPad|iPhone|iPod/.test(e)},validateGeolocation:function(e,t){const i=this;if("https:"!==location.protocol&&"localhost"!==location.hostname&&"127.0.0.1"!==location.hostname)return this.debug("Geolocation blocked: page not served over HTTPS"),void this.handleBlocked(e,t.hideMode,this.getString("httpsRequired","This form requires a secure connection (HTTPS) to access your location. Please contact the site administrator."),t.messageError);if(!navigator.geolocation)return void this.handleBlocked(e,t.hideMode,this.getString("browserNoSupport","Your browser does not support geolocation."),t.messageError);const o=this.getLocationCache(e.attr("id"));if(o)return this.debug("Using cached location",o),void this.checkLocation(e,o,t);e.find(".ffc-submission-form").hide(),e.addClass("ffc-geofence-loading"),this.showLoadingMessage(e,this.getString("detectingLocation","Detecting your location..."));var a=this.isSafari(),n=a?2e4:1e4,s=!1;function r(o){i.hideLoadingMessage(e),e.removeClass("ffc-geofence-loading");const a={latitude:o.coords.latitude,longitude:o.coords.longitude,accuracy:o.coords.accuracy};i.debug("GPS location obtained",a),t.cacheEnabled&&i.setLocationCache(e.attr("id"),a,t.cacheTtl||600),i.checkLocation(e,a,t)}function c(o){i.hideLoadingMessage(e),e.removeClass("ffc-geofence-loading");let n=t.messageError||i.getString("locationError","Unable to determine your location.");switch(o.code){case o.PERMISSION_DENIED:n=a?i.getString("safariPermissionDenied","Location access was denied. On Safari/iOS, go to Settings > Privacy & Security > Location Services and ensure it is enabled for your browser."):i.getString("permissionDenied","Location permission denied. Please enable location services.");break;case o.POSITION_UNAVAILABLE:n=a?i.getString("safariPositionUnavailable","Unable to determine your location. On Safari/iOS, ensure Location Services is enabled in Settings > Privacy & Security > Location Services."):i.getString("positionUnavailable","Location information is unavailable.");break;case o.TIMEOUT:n=a?i.getString("safariTimeout","Location request timed out. On Safari/iOS, ensure Location Services is enabled in Settings > Privacy & Security > Location Services."):i.getString("timeout","Location request timed out.")}i.handleBlocked(e,t.hideMode,n,t.messageError)}navigator.geolocation.getCurrentPosition(r,function(e){if(i.debug("Geolocation error",e),a&&!s&&(e.code===e.TIMEOUT||e.code===e.POSITION_UNAVAILABLE))return s=!0,i.debug("Safari: retrying with enableHighAccuracy=false"),void navigator.geolocation.getCurrentPosition(r,c,{enableHighAccuracy:!1,timeout:15e3,maximumAge:6e4});c(e)},{enableHighAccuracy:!0,timeout:n,maximumAge:0})},checkLocation:function(e,t,i){const o=i.areas||[];if(0===o.length)return this.debug("No areas defined, allowing access"),void this.showForm(e);let a=!1;for(let e=0;e<o.length;e++){const i=o[e],n=this.calculateDistance(t.latitude,t.longitude,i.lat,i.lng);if(this.debug("Distance check",{area:e+1,distance:n.toFixed(2)+" km",radius:i.radius+" km",within:n<=i.radius}),n<=i.radius){a=!0;break}}a?(this.debug("User within allowed area, showing form"),this.showForm(e)):this.handleBlocked(e,i.hideMode,this.getString("outsideArea","You are outside the allowed area for this form."),i.messageBlocked)},calculateDistance:function(e,t,i,o){const a=this.deg2rad(i-e),n=this.deg2rad(o-t),s=Math.sin(a/2)*Math.sin(a/2)+Math.cos(this.deg2rad(e))*Math.cos(this.deg2rad(i))*Math.sin(n/2)*Math.sin(n/2);return 6371e3*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)))},deg2rad:function(e){return e*(Math.PI/180)},showForm:function(e){e.addClass("ffc-validated"),this.debug("Form validation passed, showing form")},handleBlocked:function(e,t,i,o){const a=o||i;switch(this.debug("Blocking form",{hideMode:t,message:a}),t){case"hide":e.hide();break;case"message":e.find(".ffc-submission-form").hide(),e.find(".ffc-form-title").hide(),this.showBlockedMessage(e,a);break;default:e.find(".ffc-submission-form").hide(),this.showBlockedMessage(e,a)}},showBlockedMessage:function(e,t){const i='<div class="ffc-geofence-blocked"><p>'+this.escapeHtml(t)+"</p></div>";e.append(i)},showAdminBypassMessages:function(e,t){if(!t){const t="ðŸ”“ "+this.getString("bypassGeneric","Admin Bypass Mode Active - Geofence restrictions are disabled for administrators"),i='<div class="ffc-geofence-admin-bypass"><p>'+this.escapeHtml(t)+"</p></div>";return void e.prepend(i)}if(t.hasDatetime){const t="ðŸ”“ "+this.getString("bypassDatetime","Admin Bypass: Date/Time restrictions are disabled for administrators"),i='<div class="ffc-geofence-admin-bypass"><p>'+this.escapeHtml(t)+"</p></div>";e.prepend(i)}if(t.hasGeo){const t="ðŸ”“ "+this.getString("bypassGeo","Admin Bypass: Geolocation restrictions are disabled for administrators"),i='<div class="ffc-geofence-admin-bypass"><p>'+this.escapeHtml(t)+"</p></div>";e.prepend(i)}if(!t.hasDatetime&&!t.hasGeo){const t="ðŸ”“ "+this.getString("bypassActive","Admin Bypass Mode Active"),i='<div class="ffc-geofence-admin-bypass"><p>'+this.escapeHtml(t)+"</p></div>";e.prepend(i)}},showLoadingMessage:function(e,t){const i='<div class="ffc-geofence-loading-msg"><div class="ffc-spinner"></div><p>'+this.escapeHtml(t)+"</p></div>";e.prepend(i)},hideLoadingMessage:function(e){e.find(".ffc-geofence-loading-msg").remove()},getLocationCache:function(e){if(!localStorage)return null;const t="ffc_geo_"+e,i=localStorage.getItem(t);if(!i)return null;try{const e=JSON.parse(i),o=Math.floor(Date.now()/1e3);return e.expires&&o>e.expires?(localStorage.removeItem(t),null):e.location}catch(e){return null}},setLocationCache:function(e,t,i){if(!localStorage)return;const o="ffc_geo_"+e,a={location:t,expires:Math.floor(Date.now()/1e3)+i};localStorage.setItem(o,JSON.stringify(a))},formatDate:function(e){return e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0")},formatTime:function(e){return String(e.getHours()).padStart(2,"0")+":"+String(e.getMinutes()).padStart(2,"0")},escapeHtml:function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML},debug:function(e,t){window.ffcGeofenceConfig&&window.ffcGeofenceConfig._global&&window.ffcGeofenceConfig._global.debug&&console.log("[FFC Geofence] "+e,t||"")}};e(document).ready(function(){t.init()})}(jQuery);