!function(a){"use strict";function t(t,e){a(".ffc-accessible-alert").remove();var n=a('<div class="ffc-accessible-alert ffc-message ffc-message-error" role="alert">'+t+"</div>");e&&e.length?e.before(n):a("body").prepend(n),setTimeout(function(){n.fadeOut(300,function(){a(this).remove()})},8e3),n.attr("tabindex","-1").focus()}function e(a,t){if(a.html){if(t.html(a.html),a.pdf_data){var e=t.find(".ffc-download-btn, .ffc-download-pdf-btn");e.length&&e.attr("data-pdf-data",JSON.stringify(a.pdf_data))}}else{var n='<div class="ffc-verification-success">';if(n+="<h3>"+(ffc_ajax.strings.certificateValid||"Document Valid!")+"</h3>",a.html_preview&&(n+='<div class="ffc-certificate-preview">'+a.html_preview+"</div>"),a.form_title&&(n+="<p><strong>"+(ffc_ajax.strings.formTitle||"Form")+":</strong> "+a.form_title+"</p>"),a.auth_code&&(n+="<p><strong>"+(ffc_ajax.strings.authCode||"Auth Code")+":</strong> "+a.auth_code+"</p>"),a.submission_date&&(n+="<p><strong>"+(ffc_ajax.strings.issueDate||"Issue Date")+":</strong> "+a.submission_date+"</p>"),a.template||a.pdf_data){var f=a.pdf_data||{template:a.template,form_title:a.form_title,submission:a.submission,bg_image:a.bg_image};n+='<button class="ffc-download-pdf-btn" data-pdf-data=\''+JSON.stringify(f)+"'>"+(ffc_ajax.strings.downloadPDF||"Download PDF")+"</button>"}n+="</div>",t.html(n)}}function n(a,t){var e='<div class="ffc-verification-error">';e+="<h3>"+(ffc_ajax.strings.certificateInvalid||"Document Invalid")+"</h3>",e+="<p>"+a+"</p>",e+='<div class="ffc-manual-verification-form">',e+="<p>"+(ffc_ajax.strings.tryManually||"Or try manual verification")+":</p>",e+='<input type="text" class="ffc-manual-auth-code" placeholder="'+(ffc_ajax.strings.enterAuthCode||"Enter auth code")+'">',e+='<button class="ffc-manual-verify-btn">'+(ffc_ajax.strings.verify||"Verify")+"</button>",e+="</div>",e+="</div>",t.html(e)}window.ffcUtils=window.FFC.Frontend.Masks,a(document).on("submit",".ffc-verification-form",function(n){n.preventDefault();var f=a(this),r=f.find('input[name="ffc_auth_code"]').val().trim(),i=f.find('input[name="ffc_captcha_ans"]').val(),o=f.find('input[name="ffc_captcha_hash"]').val(),c=f.find('input[name="ffc_honeypot_trap"]').val();r?a.ajax({url:ffc_ajax.ajax_url,type:"POST",data:{action:"ffc_verify_certificate",nonce:ffc_ajax.nonce,ffc_auth_code:r,ffc_captcha_ans:i,ffc_captcha_hash:o,ffc_honeypot_trap:c},success:function(a){if(a.success)e(a.data,f.closest(".ffc-verification-container"));else{a.data&&a.data.refresh_captcha&&FFC.Frontend.UI.refreshCaptcha(f,a.data.new_label,a.data.new_hash);var t=a.data?a.data.message:ffc_ajax.strings.error||"Error",n=f.find(".ffc-verify-error");n.length||(f.find(".ffc-form-field").first().before('<div class="ffc-verify-error"></div>'),n=f.find(".ffc-verify-error")),n.html('<p class="ffc-message ffc-message-error">'+t+"</p>")}},error:function(){t(ffc_ajax.strings.connectionError||"Connection error",f)}}):t(ffc_ajax.strings.enterCode||"Please enter the code",f)}),a(document).on("click",".ffc-manual-verify-btn",function(){window.location.href=window.location.pathname}),a(document).on("click",".ffc-download-pdf-btn, .ffc-download-btn",function(){try{var e=JSON.parse(a(this).attr("data-pdf-data")||"{}"),n=e.filename||"certificate.pdf";"function"==typeof window.ffcGeneratePDF?window.ffcGeneratePDF(e,n):(console.error("[FFC] PDF generator not loaded"),t(ffc_ajax.strings.pdfLibrariesFailed||"PDF generation not available",a(this).parent()))}catch(e){console.error("[FFC] Error parsing PDF data:",e),t(ffc_ajax.strings.error||"Error occurred",a(this).parent())}}),a(document).ready(function(){setTimeout(function(){!function(){var t=a(".ffc-magic-link-container, .ffc-verification-auto-check");if(0!==t.length){var f=null;if(!(f=t.data("token"))&&window.location.hash){var r=window.location.hash;r.startsWith("#")&&(r=r.slice(1)),f=new URLSearchParams(r).get("token")}f||(f=new URLSearchParams(window.location.search).get("token")),f&&(t.find(".ffc-verification-manual").hide(),t.find(".ffc-verify-loading").show(),a.ajax({url:ffc_ajax.ajax_url,type:"POST",data:{action:"ffc_verify_magic_token",token:f},success:function(a){a.success?e(a.data,t):n(a.data?a.data.message:"Invalid token",t)},error:function(){n("Connection error. Please try again.",t)}}))}}()},100),a(document).on("submit",".ffc-submission-form, .ffc-form",function(e){e.preventDefault();var n=a(this),f=n.find('button[type="submit"]'),r=f.text(),i=!0;if(n.find("[required]").each(function(){a(this).val()?a(this).removeClass("ffc-field-error").removeAttr("aria-invalid"):(i=!1,a(this).addClass("ffc-field-error").attr("aria-invalid","true"))}),!i)return t(ffc_ajax.strings.fillRequired||"Please fill all required fields",n),void n.find(".ffc-field-error").first().focus();f.prop("disabled",!0).text(ffc_ajax.strings.processing||"Processing...");var o=n.serialize();o+="&action=ffc_submit_form",o+="&nonce="+encodeURIComponent(ffc_ajax.nonce),a.ajax({url:ffc_ajax.ajax_url,type:"POST",data:o,success:function(a){if(a.success){if(a.data.html){if(n.html(a.data.html),a.data.pdf_data){var t=n.find(".ffc-download-btn, .ffc-download-pdf-btn");t.length&&t.attr("data-pdf-data",JSON.stringify(a.data.pdf_data))}}else FFC.Frontend.UI.showFormSuccess(n,"");a.data.pdf_data&&"function"==typeof window.ffcGeneratePDF&&setTimeout(function(){var t=a.data.pdf_data.filename||"certificate.pdf";window.ffcGeneratePDF(a.data.pdf_data,t)},500)}else{var e=a.data?a.data.message:ffc_ajax.strings.error||"Error occurred";FFC.Frontend.UI.showFormError(n,e),a.data&&a.data.refresh_captcha&&FFC.Frontend.UI.refreshCaptcha(n,a.data.new_label,a.data.new_hash),f.prop("disabled",!1).text(r)}},error:function(a,e,i){try{var o=a.responseJSON;if(o&&o.data&&o.data.rate_limit)return FFC.Frontend.RateLimit.show(o.data.message,o.data.wait_seconds),void f.prop("disabled",!1).text(r)}catch(a){}t(ffc_ajax.strings.connectionError||"Connection error",n),f.prop("disabled",!1).text(r)}})}),FFC.Frontend.Masks?(FFC.Frontend.Masks.applyAuthCode(),FFC.Frontend.Masks.applyCpfRf(),FFC.Frontend.Masks.applyTicket(),function(){if(FFC.Frontend.Masks){var t=new MutationObserver(function(e){var n=!1,f=!1,r=!1;e.forEach(function(t){0!==t.addedNodes.length&&t.addedNodes.forEach(function(t){if(1===t.nodeType){var e=a(t);(e.hasClass("ffc-manual-auth-code")||e.find(".ffc-manual-auth-code").length||e.find(".ffc-verify-input").length)&&(n=!0),("cpf_rf"===e.attr("name")||"cpf"===e.attr("name")||e.find('input[name="cpf_rf"], input[name="cpf"]').length)&&(f=!0),("ffc_ticket"===e.attr("name")||e.hasClass("ffc-ticket-input")||e.find('input[name="ffc_ticket"], .ffc-ticket-input').length)&&(r=!0)}})}),(n||f||r)&&(clearTimeout(t.maskTimeout),t.maskTimeout=setTimeout(function(){n&&FFC.Frontend.Masks.applyAuthCode(),f&&FFC.Frontend.Masks.applyCpfRf(),r&&FFC.Frontend.Masks.applyTicket()},50))});return t.observe(document.body,{childList:!0,subtree:!0}),t}console.warn("[FFC] Frontend helpers not loaded - dynamic masks disabled")}()):console.warn("[FFC] Frontend helpers not loaded - masks disabled"),a(document).on("input","textarea.ffc-input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})})}(jQuery);