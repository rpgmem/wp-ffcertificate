!function(e,t){"use strict";function o(t,o){console.log("[FFC] Loading template:",t);var i="/wp-content/plugins/ffcertificate/html/"+t,a=window.FFC.Admin.showNotification||function(){},n="undefined"!=typeof ffc_ajax&&ffc_ajax.strings?ffc_ajax.strings:{},r=n.loadingTemplate||"Loading template...";a(r,"info",0),fetch(i).then(function(e){if(console.log("[FFC] Fetch response status:",e.status),!e.ok)throw new Error("HTTP error! status: "+e.status);return e.text()}).then(function(i){console.log("[FFC] Template loaded, length:",i.length);var r=e("#ffc_pdf_layout");if(r.length){r.val(i),r.trigger("change");var l=(n.templateLoadedSuccess||'Template "%s" loaded successfully!').replace("%s",o||t);a("✓ "+l,"success",3e3),console.log("[FFC] ✓ Template loaded into #ffc_pdf_layout")}else{var c=n.htmlFieldNotFound||"HTML field not found.";a("✗ "+c,"error"),console.error("[FFC] ✗ HTML field #ffc_pdf_layout not found")}}).catch(function(e){console.error("[FFC] ✗ Fetch error:",e);var t="";if(e.message.includes("404"))t=n.templateFileNotFound||"Template file not found. Check if file exists in html/ folder.";else if(e.message.includes("403"))t=n.accessDenied||"Access denied. Check file permissions.";else if(e.message.includes("Failed to fetch"))t=n.networkError||"Network error. Check your connection.";else{t=(n.errorLoadingTemplate||"Error loading template: %s").replace("%s",e.message)}a("✗ "+t,"error",8e3)})}e(document).on("click","#ffc_load_template_btn",function(t){t.preventDefault(),console.log("[FFC] Load Template button clicked");var i="undefined"!=typeof ffc_ajax&&ffc_ajax.strings?ffc_ajax.strings:{},a=i.selectTemplate||"Select a Template",n=i.cancel||"Cancel",r='<div id="ffc-template-modal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:999999;display:flex;align-items:center;justify-content:center;">';r+='<div style="background:#fff;padding:30px;border-radius:8px;max-width:500px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.3);">',r+='<h2 style="margin:0 0 20px 0;font-size:20px;">'+a+"</h2>",r+='<div style="max-height:400px;overflow-y:auto;">',[{value:"atestado_estagios.html",label:"Atestado de Estágios"},{value:"certificado_1.html",label:"Certificado Modelo 1"},{value:"certificado_2.html",label:"Certificado Modelo 2"},{value:"declaracao.html",label:"Declaração"}].forEach(function(e){r+='<div class="ffc-template-option" data-file="'+e.value+'" style="padding:15px;margin:10px 0;border:2px solid #ddd;border-radius:4px;cursor:pointer;transition:all 0.2s;">',r+='<strong style="font-size:16px;">'+e.label+"</strong>",r+='<div style="color:#666;font-size:13px;margin-top:5px;">'+e.value+"</div>",r+="</div>"}),r+="</div>",r+='<div style="margin-top:20px;text-align:right;">',r+='<button id="ffc-modal-cancel" class="button" style="margin-right:10px;">'+n+"</button>",r+="</div>",r+="</div></div>",e("body").append(r),e(".ffc-template-option").hover(function(){e(this).css({"border-color":"#2271b1",background:"#f0f6fc"})},function(){e(this).css({"border-color":"#ddd",background:"transparent"})}),e("#ffc-modal-cancel").on("click",function(){e("#ffc-template-modal").fadeOut(200,function(){e(this).remove()})}),e("#ffc-template-modal").on("click",function(t){"ffc-template-modal"===t.target.id&&e(this).fadeOut(200,function(){e(this).remove()})}),e(".ffc-template-option").on("click",function(){var t=e(this).data("file"),i=e(this).find("strong").text();e("#ffc-template-modal").remove();var a="undefined"!=typeof ffc_ajax&&ffc_ajax.strings&&ffc_ajax.strings.confirmLoadTemplate?ffc_ajax.strings.confirmLoadTemplate.replace("%s",i):'Load "'+i+'"? This will replace your current certificate HTML.';confirm(a)&&o(t,i)})}),e(document).on("click","#ffc_btn_import_html",function(t){t.preventDefault(),console.log("[FFC] Import HTML clicked");var o=window.FFC.Admin.showNotification||function(){},i=e("#ffc_import_html_file");if(i.length||(i=e('input[type="file"][name*="import"]')),i.length)console.log("[FFC] File input found, clicking..."),i.click();else{console.log("[FFC] File input not found, creating temporary input");var a=e('<input type="file" accept=".html" style="display:none">');e("body").append(a),a.on("change",function(t){var i=t.target.files[0];if(i){var n="undefined"!=typeof ffc_ajax&&ffc_ajax.strings?ffc_ajax.strings:{};if("text/html"===i.type||i.name.endsWith(".html")){var r=new FileReader;r.onload=function(t){var i=e("#ffc_pdf_layout");if(i.length){i.val(t.target.result);var r=n.htmlImportedSuccess||"HTML imported successfully!";o(r,"success"),console.log("[FFC] HTML file imported to #ffc_pdf_layout")}else{var l=n.htmlFieldNotFound||"HTML field not found.";o("Error: "+l,"error"),console.error("[FFC] HTML field not found")}a.remove()},r.readAsText(i)}else{var l=n.selectHtmlFile||"Please select an HTML file.";o(l,"warning")}}}),a.click()}}),e(document).on("change",'#ffc_import_html_file, input[type="file"][name*="import"]',function(t){var o=t.target.files[0];if(o){console.log("[FFC] File selected via change handler:",o.name);var i=window.FFC.Admin.showNotification||function(){},a="undefined"!=typeof ffc_ajax&&ffc_ajax.strings?ffc_ajax.strings:{},n=new FileReader;n.onload=function(t){var o=e("#ffc_pdf_layout");if(o.length){o.val(t.target.result),console.log("[FFC] ✓ HTML imported to #ffc_pdf_layout");var n=a.htmlImportedSuccess||"HTML imported successfully!";i(n,"success")}else{console.error("[FFC] ✗ Field #ffc_pdf_layout not found");var r=a.htmlTextareaNotFound||"HTML textarea not found";i("Error: "+r,"error")}},n.onerror=function(){console.error("[FFC] Error reading file");var e=a.errorReadingFile||"Error reading file";i(e,"error")},n.readAsText(o),e(this).val("")}});var i,a={name:"John Doe",email:"john_doe@example.com",cpf_rf:"123.456.789-00",cpf:"123.456.789-00",auth_code:"A1B2-C3D4-E5F6",form_title:e("#title").val()||"Certificate Title",submission_date:(new Date).toLocaleDateString("pt-BR",{year:"numeric",month:"long",day:"numeric"}),print_date:(new Date).toLocaleDateString("pt-BR",{year:"numeric",month:"long",day:"numeric"}),fill_date:(new Date).toLocaleDateString("pt-BR",{year:"numeric",month:"long",day:"numeric"}),date:(new Date).toLocaleDateString("pt-BR",{year:"numeric",month:"long",day:"numeric"}),submission_id:"1234",magic_token:"abc123def456ghi789jkl012",ticket:"TK01-AB2C-3D4E"};e(document).on("click","#ffc_btn_preview",function(t){t.preventDefault();var o=e("#ffc_pdf_layout").val(),i="undefined"!=typeof ffc_ajax&&ffc_ajax.strings?ffc_ajax.strings:{};if(o&&o.trim()){var n,r=e("#ffc_bg_image_input, #ffc_bg_image_url").first().val()||"",l=function(e,t){return(e=(e=e.replace(/\{\{(\w+)\}\}/g,function(e,o){return void 0!==t[o]?t[o]:e})).replace(/\{\{qr_code[^}]*\}\}/g,'<svg width="150" height="150" viewBox="0 0 150 150" xmlns="http://www.w3.org/2000/svg"><rect width="150" height="150" fill="#f0f0f0" stroke="#ccc" stroke-width="1"/><text x="75" y="70" text-anchor="middle" font-size="12" fill="#999">QR Code</text><text x="75" y="90" text-anchor="middle" font-size="10" fill="#bbb">(preview)</text></svg>')).replace(/\{\{validation_url[^}]*\}\}/g,'<a href="#" style="color:#0073aa;">https://example.com/valid/#token=abc123</a>')}(o,((n=e.extend({},a)).form_title=e("#title").val()||n.form_title,e("#ffc-fields-container .ffc-field-row").each(function(){var t=e(this).find('input[name*="[name]"]').val(),o=e(this).find('input[name*="[label]"]').val();t&&!n[t]&&(n[t]=o||t)}),n)),c='<!DOCTYPE html><html><head><meta charset="UTF-8">';c+="<style>",c+="html, body { margin: 0; padding: 0; }",c+="body { font-family: Arial, Helvetica, sans-serif; ",r&&(c+="background-image: url("+r+"); ",c+="background-size: cover; background-position: center; background-repeat: no-repeat; "),c+="}",c+="</style></head><body>",c+=l,c+="</body></html>";var f=i.previewTitle||"Certificate Preview",d=i.close||"Close",s=i.previewSampleNote||"Placeholders replaced with sample data. QR code shown as placeholder.",m=e('<div id="ffc-preview-modal"><div class="ffc-preview-backdrop"></div><div class="ffc-preview-container"><div class="ffc-preview-header"><h2>'+f+'</h2><button type="button" class="ffc-preview-close" title="'+d+'">&times;</button></div><div class="ffc-preview-note">'+s+'</div><div class="ffc-preview-body"><iframe id="ffc-preview-iframe" frameborder="0"></iframe></div></div></div>');e("body").append(m);var u=document.getElementById("ffc-preview-iframe"),p=u.contentWindow||u.contentDocument;p.document&&(p=p.document),p.open(),p.write(c),p.close(),requestAnimationFrame(function(){m.addClass("ffc-preview-visible")}),m.find(".ffc-preview-close").on("click",v),m.find(".ffc-preview-backdrop").on("click",v),e(document).on("keydown.ffcPreview",function(t){"Escape"===t.key&&(v(),e(document).off("keydown.ffcPreview"))})}else{var g=i.previewEmpty||"The HTML editor is empty. Add a template first.";alert(g)}function v(){m.removeClass("ffc-preview-visible"),setTimeout(function(){m.remove()},200)}}),e(document).on("click","#ffc_btn_media_lib",function(t){t.preventDefault(),console.log("[FFC] Background Image clicked");var o=window.FFC.Admin.showNotification||function(){},a="undefined"!=typeof ffc_ajax&&ffc_ajax.strings?ffc_ajax.strings:{};if("undefined"==typeof wp||void 0===wp.media){var n=a.wpMediaNotAvailable||"WordPress Media Library is not available. Please reload the page.";return o(n,"error"),void console.error("[FFC] wp.media is not defined")}if(i)i.open();else{var r=a.chooseBackgroundImage||"Choose Background Image",l=a.useThisImage||"Use this image";(i=wp.media({title:r,button:{text:l},multiple:!1})).on("select",function(){var t=i.state().get("selection").first().toJSON(),n=e("#ffc_bg_image_url");n.length||(n=e('input[name*="bg_image"], input[name*="background"]').first()),n.length&&n.val(t.url);var r=e("#ffc_bg_image_preview");r.length&&r.html('<img src="'+t.url+'" style="max-width: 200px; height: auto;">');var l=a.backgroundImageSelected||"Background image selected!";o(l,"success"),console.log("[FFC] Background image selected:",t.url)}),i.open()}}),window.FFC=window.FFC||{},window.FFC.Admin=window.FFC.Admin||{},window.FFC.Admin.PDF={loadTemplate:o},t.registerModule&&t.registerModule("Admin.PDF","3.1.0"),console.log("[FFC Admin PDF] Module loaded v3.1.0")}(jQuery,window.FFC);